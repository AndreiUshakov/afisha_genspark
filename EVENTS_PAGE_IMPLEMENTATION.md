# Реализация страницы мероприятий с фильтрами

## Обзор

Реализована полнофункциональная страница `/events` с подключением к базе данных Supabase и системой фильтрации.

## Компоненты реализации

### 1. Миграция БД - Таблица категорий
**Файл:** `supabase/migrations/20241219_create_categories_table.sql`

Создана таблица `categories` со следующими полями:
- `id` - UUID первичный ключ
- `name` - название категории
- `slug` - уникальный идентификатор
- `description` - описание
- `icon` - emoji иконка для UI
- `color` - цветовая схема
- `parent_id` - для иерархической структуры
- `sort_order` - порядок сортировки
- `is_active` - статус активности

**Предзаполненные категории:**
- Концерты и Музыка
- Театр и Перформанс
- Выставки и Искусство
- Образование
- Спорт
- Фестивали
- Для Детей
- Кино и Медиа
- Развлечения и Ночная жизнь
- Гастрономия
- Хобби и Ремесла
- Экология и ЗОЖ
- Бизнес и Нетворкинг
- Психология и Духовное развитие
- Мода и Красота

### 2. Server Actions
**Файл:** `app/events/actions.ts`

#### Функции:
- `getEvents(filters)` - получение событий с фильтрацией и пагинацией
- `getCategories()` - получение всех активных категорий
- `getEventBySlug(slug)` - получение конкретного события
- `getRelatedEvents()` - похожие события
- `getFeaturedEvents()` - избранные события
- `getUpcomingEvents()` - предстоящие события

#### Поддерживаемые фильтры:
```typescript
interface EventFilters {
  categoryId?: string;           // ID категории
  wishes?: string[];             // "Я хочу" фильтр
  targetAudience?: string[];     // Целевая аудитория
  ageCategories?: string[];      // Возрастные категории
  format?: 'online' | 'offline' | 'hybrid';  // Формат
  priceType?: 'free' | 'paid' | 'donation';  // Тип цены
  priceMin?: number;             // Минимальная цена
  priceMax?: number;             // Максимальная цена
  dateFrom?: string;             // Дата начала
  dateTo?: string;               // Дата окончания
  search?: string;               // Текстовый поиск
  sortBy?: 'date' | 'popularity' | 'price';  // Сортировка
  sortOrder?: 'asc' | 'desc';    // Порядок сортировки
  page?: number;                 // Страница
  perPage?: number;              // Элементов на странице
}
```

### 3. API Route
**Файл:** `app/api/events/route.ts`

REST API endpoint для получения событий с фильтрами через GET запрос.

**Пример запроса:**
```
GET /api/events?category=concerts-music&sortBy=date&page=1
```

### 4. Клиентский компонент
**Файл:** `components/events/EventsPageClient.tsx`

React компонент с состоянием фильтров:
- Управление фильтрами через dropdown меню
- Интеграция с URL (query parameters)
- Динамическая подгрузка данных
- Пагинация
- Индикация загрузки

**Особенности:**
- Фильтры синхронизируются с URL
- Поддержка истории браузера
- Оптимизированная перерисовка

### 5. Обновленная страница
**Файл:** `app/events/page.tsx`

Server Component который:
- Получает параметры из URL
- Запрашивает данные из БД
- Передает данные клиентскому компоненту

## Использованные поля таблицы events

Для фильтрации используются поля из миграции `add_event_filter_fields.sql`:
- `event_type` - тип мероприятия (связан с категорией)
- `target_audience` - массив целевой аудитории
- `wishes` - массив целей/желаний
- `age_categories` - возрастные категории

## Работа фильтров

### 1. Фильтр по категориям
Отображается в виде кнопок сверху страницы с иконками категорий.

### 2. Дополнительные фильтры
Реализованы как выпадающие меню:
- **Я хочу** - множественный выбор целей посещения
- **Тип мероприятия** - выбор из категорий
- **Возраст** - возрастные ограничения
- **Формат** - онлайн/офлайн
- **Дата** - calendar picker с пресетами
- **Для кого** - целевая аудитория
- **Цена** - диапазоны цен

### 3. Сортировка
- По дате
- По популярности (количество просмотров)
- По цене

### 4. Пагинация
- Постраничная навигация
- Configurable количество элементов на странице (по умолчанию 12)

## Query параметры URL

Примеры:
```
/events?category=concerts-music
/events?category=concerts-music&sortBy=popularity
/events?wishes=Посмотреть,Развлечься&age=Взрослые%2018+
/events?dateFrom=2025-12-20T00:00:00Z&dateTo=2025-12-31T23:59:59Z
/events?priceType=free
/events?page=2
```

## Необходимые доработки

1. **Применить миграцию БД:**
   ```bash
   npx supabase db push
   ```
   или через Supabase Dashboard выполнить SQL из файла миграции.

2. **Добавить тестовые данные:**
   Необходимо добавить события в БД с заполненными полями фильтрации.

3. **Обновить EventCard компонент:**
   Убедиться, что компонент корректно работает с новой структурой данных из БД.

4. **Тестирование:**
   - Проверить работу всех фильтров
   - Проверить пагинацию
   - Проверить сортировку
   - Проверить производительность с большим количеством событий

## RLS Политики

Таблица `categories` имеет следующие политики:
- **SELECT:** Все могут читать активные категории
- **ALL:** Только админы могут управлять категориями

## Индексы БД

Созданы индексы для оптимизации запросов:
- `idx_events_event_type` - для фильтрации по типу
- `idx_events_target_audience` - GIN индекс для массивов
- `idx_events_wishes` - GIN индекс для массивов
- `idx_events_age_categories` - GIN индекс для массивов
- `idx_categories_slug` - для поиска по slug
- `idx_categories_active` - для фильтрации активных

## Производительность

Оптимизации:
- Использование GIN индексов для массивов
- Пагинация на уровне БД
- Server-side рендеринг начальных данных
- Client-side навигация для последующих запросов
- Кеширование через Next.js

## Следующие шаги

1. Создать компонент для расширенных фильтров (отдельная панель)
2. Добавить сохранение фильтров в localStorage
3. Добавить "избранные фильтры" для быстрого доступа
4. Реализовать полнотекстовый поиск
5. Добавить фильтр по геолокации
6. Добавить рекомендации на основе истории просмотров