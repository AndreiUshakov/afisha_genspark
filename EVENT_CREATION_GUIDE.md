# Руководство по созданию мероприятий

## Обзор

Реализована полная система создания мероприятий для сообществ с пошаговым процессом, аналогичным созданию и настройке сообщества.

## Структура страниц

```
app/dashboard/community/[slug]/events/create/
├── page.tsx                           # Главная страница с выбором разделов
├── actions.ts                         # Серверные actions для работы с мероприятиями
├── basic/
│   ├── page.tsx                       # Страница основных настроек
│   └── components/
│       └── BasicEventForm.tsx         # Форма основных настроек
├── design/
│   ├── page.tsx                       # Страница оформления
│   └── components/
│       └── DesignEventForm.tsx        # Форма оформления
├── content/
│   └── page.tsx                       # Страница контента (заглушка)
└── preview/
    ├── page.tsx                       # Страница предпросмотра
    └── components/
        └── PublishEventButton.tsx     # Кнопка публикации
```

## Функционал

### 1. Главная страница создания (/events/create)

**Файл:** [`page.tsx`](app/dashboard/community/[slug]/events/create/page.tsx:1)

Отображает 4 основных раздела:
- **Основные настройки** - название, описание, дата, место, цена
- **Оформление** - обложка, фотогалерея, команда
- **Контент** - детальное описание блоками (в разработке)
- **Предпросмотр** - финальный просмотр и публикация

### 2. Основные настройки (/events/create/basic)

**Файлы:**
- [`page.tsx`](app/dashboard/community/[slug]/events/create/basic/page.tsx:1)
- [`BasicEventForm.tsx`](app/dashboard/community/[slug]/events/create/basic/components/BasicEventForm.tsx:1)

**Функции:**
- Создание черновика мероприятия
- Заполнение основной информации:
  - Название и описание (обязательно)
  - Категория события
  - Дата и время начала/окончания
  - Повторяющееся мероприятие (опционально)
  - Формат: офлайн/онлайн/гибрид
  - Место проведения или ссылка на трансляцию
  - Стоимость участия (бесплатно/платно)
  - Вместимость
  - Возрастное ограничение
  - Теги

**Автоматическое заполнение:**
- Организатор: имя и аватар сообщества
- Тип организатора: "community"
- Генерация уникального slug

### 3. Оформление (/events/create/design)

**Файлы:**
- [`page.tsx`](app/dashboard/community/[slug]/events/create/design/page.tsx:1)
- [`DesignEventForm.tsx`](app/dashboard/community/[slug]/events/create/design/components/DesignEventForm.tsx:1)

**Функции:**
- Загрузка обложки мероприятия (до 5 МБ)
- Выбор изображений из медиагалереи сообщества
- Формирование фотогалереи события
- Возможность использования общих медиа сообщества

**Особенности:**
- Интеграция с медиагалереей сообщества
- Повторное использование фотографий команды, помещений
- Предпросмотр загруженных изображений

### 4. Контент (/events/create/content)

**Файл:** [`page.tsx`](app/dashboard/community/[slug]/events/create/content/page.tsx:1)

**Статус:** Заглушка для будущей реализации

**Планируется:**
- Конструктор блоков (аналогичный странице "О сообществе")
- Детальное описание мероприятия
- Программа события
- Информация о спикерах

### 5. Предпросмотр и публикация (/events/create/preview)

**Файлы:**
- [`page.tsx`](app/dashboard/community/[slug]/events/create/preview/page.tsx:1)
- [`PublishEventButton.tsx`](app/dashboard/community/[slug]/events/create/preview/components/PublishEventButton.tsx:1)

**Функции:**
- Полный предпросмотр мероприятия
- Отображение всех заполненных данных
- Кнопка публикации
- Информация о процессе модерации

**Процесс публикации:**
1. Организатор нажимает "Опубликовать"
2. Мероприятие отправляется на пост-модерацию
3. Администраторы проверяют информацию
4. После одобрения событие появляется в каталоге

## Серверные Actions

**Файл:** [`actions.ts`](app/dashboard/community/[slug]/events/create/actions.ts:1)

### createEventDraft
Создает черновик мероприятия с автоматическим заполнением полей из сообщества.

**Параметры:**
```typescript
{
  communityId: string
  communitySlug: string
  data: CreateEventBasicData
}
```

**Возвращает:**
```typescript
{
  success: boolean
  data?: Event
  error?: string
}
```

### updateEventBasic
Обновляет основные настройки мероприятия.

### updateEventDesign
Обновляет оформление мероприятия (обложка, галерея).

**Параметры:** FormData с файлами

### publishEvent
Публикует мероприятие и отправляет на модерацию.

**Функции:**
- Проверка обязательных полей
- Установка статуса `is_published = true`
- Триггер создания задачи модерации (на уровне БД)

### getEventCategories
Получает список категорий для мероприятий.

### getCommunityMedia
Получает медиагалерею сообщества для использования в оформлении.

## Поток создания мероприятия

```
1. Основные настройки
   ↓ (создается черновик)
2. Оформление
   ↓ (загружается обложка, выбирается галерея)
3. Контент
   ↓ (в разработке)
4. Предпросмотр
   ↓ (публикация)
5. Пост-модерация администраторами
   ↓
6. Публикация в каталоге
```

## Автоматизация

### Поля, заполняемые автоматически:
- `organizer_id` - ID текущего пользователя
- `organizer_name` - название сообщества
- `organizer_avatar` - аватар сообщества
- `organizer_type` - "community"
- `community_id` - ID сообщества
- `slug` - генерируется из названия + timestamp
- `is_published` - false (черновик)
- `registered_count` - 0
- `views_count` - 0
- `favorites_count` - 0

### Поля из настроек сообщества по умолчанию:
- Фильтры аудитории (могут быть переопределены)
- Категория по умолчанию сообщества

## Интеграция с медиагалереей

Мероприятия могут использовать:
- Фотографии из общей медиагалереи сообщества
- Фото команды (спикеры, ведущие, артисты)
- Фотографии помещений и локаций
- Архивные изображения с предыдущих событий

**Преимущества:**
- Экономия места на диске
- Консистентность визуального стиля
- Быстрый доступ к проверенным материалам

## Модерация

### Пост-модерация
Мероприятия публикуются сразу организатором, но:
- Создается задача модерации в таблице `moderation_tasks`
- Администраторы проверяют содержимое
- При необходимости могут снять публикацию
- Триггер срабатывает при `is_published = true`

**Триггер:** `update_moderation_task_on_publish()`

```sql
create trigger update_event_moderation_task_trigger
after update on events 
for each row when (
  old.is_published is distinct from new.is_published
  and new.is_published = true
)
execute function update_moderation_task_on_publish();
```

## Валидация

### Обязательные поля:
- Название мероприятия
- Описание (до 500 символов)
- Категория
- Дата начала

### Условная валидация:
- Если офлайн → требуется название места
- Если онлайн → требуется ссылка на трансляцию
- Если платное → требуется минимальная цена

## Навигация

Каждый подраздел содержит:
- Кнопку "Назад" к предыдущему шагу
- Кнопку "Продолжить" к следующему шагу
- Кнопку "Пропустить" для необязательных разделов
- Ссылку на главную страницу выбора разделов

## Безопасность

### Проверки доступа:
1. Пользователь авторизован
2. Сообщество принадлежит пользователю
3. Мероприятие принадлежит сообществу пользователя

### RLS политики:
Используются существующие политики для таблицы `events`:
- Владельцы сообществ могут создавать мероприятия
- Владельцы могут редактировать свои мероприятия
- Все могут просматривать опубликованные мероприятия

## Будущие улучшения

1. **Конструктор контента**
   - Блоки текста, изображений, видео
   - Программа мероприятия
   - Информация о спикерах

2. **Расширенные настройки**
   - Рассылка уведомлений участникам
   - Интеграция с календарями
   - Экспорт данных участников

3. **Аналитика**
   - Просмотры мероприятия
   - Конверсия регистраций
   - Источники трафика

4. **Повторяющиеся события**
   - Полная поддержка reccurrence patterns
   - Управление серией событий
   - Отмена отдельных экземпляров

## Связь с другими модулями

### Интеграция:
- **Сообщества** - владелец и организатор
- **Медиагалерея** - использование общих медиа
- **Модерация** - пост-модерация администраторами
- **Категории** - классификация событий
- **Профили** - участники и организаторы

## Примеры использования

### Создание офлайн мероприятия:
```
1. Основные настройки:
   - Название: "Мастер-класс по живописи"
   - Категория: "Искусство"
   - Дата: 25.12.2024 18:00
   - Формат: Офлайн
   - Место: "Арт-пространство 'Среда'"
   - Адрес: "ул. Пушкина, д. 10"
   - Бесплатно

2. Оформление:
   - Загрузить обложку
   - Выбрать 5 фото из галереи сообщества

3. Предпросмотр и публикация
```

### Создание онлайн мероприятия:
```
1. Основные настройки:
   - Название: "Вебинар: Современное искусство"
   - Категория: "Образование"
   - Дата: 30.12.2024 19:00
   - Формат: Онлайн
   - Ссылка: "https://zoom.us/j/123456789"
   - Цена: от 500₽

2. Оформление:
   - Загрузить обложку

3. Предпросмотр и публикация
```

## Техническая реализация

### Стек технологий:
- **Next.js 15** - App Router
- **React Server Components** - серверный рендеринг
- **Supabase** - база данных и хранилище
- **TypeScript** - типизация
- **Tailwind CSS** - стилизация

### Паттерны:
- Server Actions для мутаций
- Client Components для интерактивности
- Optimistic UI для лучшего UX
- Progressive Enhancement

## Заключение

Реализована полнофункциональная система создания мероприятий с:
- Пошаговым процессом настройки
- Автоматическим заполнением из сообщества
- Интеграцией с медиагалереей
- Системой пост-модерации
- Валидацией и проверками безопасности
- Responsive дизайном
- Dark mode поддержкой