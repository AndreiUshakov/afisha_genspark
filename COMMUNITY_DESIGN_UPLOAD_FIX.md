# Исправление загрузки обложки и логотипа сообщества

## Проблема
Обложка и логотип сообщества не сохранялись, появлялось сообщение "Ошибка при загрузке обложки". Хотя изображения корректно показывались на предпросмотре и не превышали 5 МБ, а бакет `communities` был публичным.

## Выявленные проблемы

### 1. Использование прямого URL вместо прокси
В actions.ts использовался прямой публичный URL от Supabase, в то время как в других частях приложения используется прокси URL через /api/storage/.

### 2. Отсутствие обработки удаления изображений
Когда пользователь нажимал "Удалить" для обложки или логотипа, файлы устанавливались в null на клиенте, но на сервере не было механизма для обработки явного удаления.

### 3. Неправильное извлечение пути файла при удалении
При замене или удалении старого файла путь извлекался только через split, что не учитывало структуру прокси URL.

### 4. Недостаточное логирование
Отсутствовало детальное логирование для диагностики проблем.

### 5. Неправильные RLS политики Storage (КРИТИЧЕСКАЯ ПРОБЛЕМА)
Основная проблема была в Row-Level Security политиках для бакета communities в Supabase.

## Внесённые исправления

### 1. Использование прокси URL
Изменён способ получения URL с прямого на прокси для избежания mixed content ошибок

### 2. Добавлена поддержка удаления изображений
- Добавлены флаги removeAvatar и removeCover
- Серверная обработка удаления файлов из storage
- Клиентская отправка флагов удаления

### 3. Улучшенное извлечение пути файла
Теперь корректно извлекается путь как из прокси URL, так и из прямого URL

### 4. Добавлено детальное логирование
Логирование всех операций загрузки и удаления с деталями ошибок

### 5. Добавлена валидация файлов
- Проверка типа файла (только изображения)
- Проверка размера файла (максимум 5MB)
- Валидация на клиенте и сервере

## КРИТИЧЕСКОЕ ОБНОВЛЕНИЕ: Исправление RLS политик

### Проблема с политиками

После внесения изменений в код обнаружилась ошибка:
```
Ошибка при загрузке логотипа: new row violates row-level security policy
```

### Первая попытка исправления (неудачная)
Использовалась конструкция `(string_to_array(name, '/'))[1]` для извлечения communityId из пути, но это не работало корректно.

### Правильное решение (v2)
Используется функция `split_part(name, '/', 1)` которая:
- Более эффективна для извлечения первой части пути
- Не создаёт массив в памяти
- Более читаема и надёжна

### SQL скрипт для исправления

**Файл:** `supabase/fix-communities-storage-policies-v2.sql`

Ключевые изменения в политиках:

```sql
-- БЫЛО (не работало):
WHERE id::text = (string_to_array(name, '/'))[1]

-- СТАЛО (работает):
WHERE id::text = split_part(name, '/', 1)
```

Полная политика INSERT:
```sql
CREATE POLICY "Community owners can upload images"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'communities'
  AND auth.uid() IS NOT NULL
  AND EXISTS (
    SELECT 1 
    FROM public.communities 
    WHERE id::text = split_part(name, '/', 1)
    AND owner_id = auth.uid()
  )
);
```

### Почему split_part лучше string_to_array

1. **Производительность**: `split_part` не создаёт массив в памяти, работает быстрее
2. **Надёжность**: Меньше вероятность ошибок при работе с индексами массива
3. **Читаемость**: Код более понятен - "разделить и взять первую часть"
4. **Стандартность**: `split_part` - стандартная PostgreSQL функция для этой задачи

### Как применить исправление

1. **Откройте Supabase Dashboard → SQL Editor**

2. **Выполните SQL скрипт из файла:**
   `supabase/fix-communities-storage-policies-v2.sql`

3. **Проверьте что политики созданы:**
   ```sql
   SELECT policyname, cmd 
   FROM pg_policies 
   WHERE tablename = 'objects' 
   AND schemaname = 'storage'
   AND policyname LIKE '%ommunit%';
   ```

4. **Должны быть 4 политики:**
   - Communities public read access (SELECT)
   - Community owners can upload images (INSERT)
   - Community owners can update images (UPDATE)
   - Community owners can delete images (DELETE)

## Изменённые файлы

1. app/dashboard/community/[slug]/settings/design/actions.ts
2. app/dashboard/community/[slug]/settings/design/components/DesignSettingsForm.tsx
3. supabase/fix-communities-storage-policies-v2.sql (новый)
4. docs/COMMUNITY_STORAGE_SETUP.md (обновлён)

## Тестирование

После внесения изменений необходимо протестировать:

1. Загрузку нового логотипа
2. Загрузку новой обложки
3. Замену существующего логотипа
4. Замену существующей обложки
5. Удаление логотипа
6. Удаление обложки
7. Проверку ограничения размера файла
8. Проверку типа файла
9. Отображение корректных сообщений об ошибках
10. Предпросмотр изображений перед сохранением

## Примечания

- Бакет communities должен быть настроен как публичный в Supabase Storage
- RLS политики должны быть настроены согласно файлу fix-communities-storage-policies-v2.sql
- API роут /api/storage/communities должен быть настроен для проксирования запросов
- Все пути файлов должны иметь формат: {communityId}/{filename}
- communityId это UUID, а не slug

## Дополнительная документация

- `docs/COMMUNITY_STORAGE_SETUP.md` - полная инструкция по настройке Storage с troubleshooting
- `supabase/fix-communities-storage-policies-v2.sql` - правильный SQL скрипт для политик