# Исправление загрузки обложки и логотипа сообщества

## Проблема
Обложка и логотип сообщества не сохранялись, появлялось сообщение "Ошибка при загрузке обложки". Хотя изображения корректно показывались на предпросмотре и не превышали 5 МБ, а бакет `communities` был публичным.

## Выявленные проблемы

### 1. Использование прямого URL вместо прокси
В actions.ts использовался прямой публичный URL от Supabase, в то время как в других частях приложения используется прокси URL через /api/storage/.

### 2. Отсутствие обработки удаления изображений
Когда пользователь нажимал "Удалить" для обложки или логотипа, файлы устанавливались в null на клиенте, но на сервере не было механизма для обработки явного удаления.

### 3. Неправильное извлечение пути файла при удалении
При замене или удалении старого файла путь извлекался только через split, что не учитывало структуру прокси URL.

### 4. Недостаточное логирование
Отсутствовало детальное логирование для диагностики проблем.

## Внесённые исправления

### 1. Использование прокси URL
Изменён способ получения URL с прямого на прокси для избежания mixed content ошибок

### 2. Добавлена поддержка удаления изображений
- Добавлены флаги removeAvatar и removeCover
- Серверная обработка удаления файлов из storage
- Клиентская отправка флагов удаления

### 3. Улучшенное извлечение пути файла
Теперь корректно извлекается путь как из прокси URL, так и из прямого URL

### 4. Добавлено детальное логирование
Логирование всех операций загрузки и удаления с деталями ошибок

### 5. Добавлена валидация файлов
- Проверка типа файла (только изображения)
- Проверка размера файла (максимум 5MB)
- Валидация на клиенте и сервере

## Изменённые файлы

1. app/dashboard/community/[slug]/settings/design/actions.ts
2. app/dashboard/community/[slug]/settings/design/components/DesignSettingsForm.tsx

## Тестирование

После внесения изменений необходимо протестировать:

1. Загрузку нового логотипа
2. Загрузку новой обложки
3. Замену существующего логотипа
4. Замену существующей обложки
5. Удаление логотипа
6. Удаление обложки
7. Проверку ограничения размера файла
8. Проверку типа файла
9. Отображение корректных сообщений об ошибках
10. Предпросмотр изображений перед сохранением

## Примечания

- Бакет communities должен быть настроен как публичный в Supabase Storage
- API роут /api/storage/communities должен быть настроен для проксирования запросов
- Все пути файлов должны иметь формат: {communityId}/{filename}