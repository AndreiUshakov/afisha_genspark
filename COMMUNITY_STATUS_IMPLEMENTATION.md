# Реализация расширенных статусов для сообществ

## Обзор

Реализована система статусов для сообществ с поддержкой черновиков и модерации. Теперь владелец сообщества может создать сообщество в режиме черновика, наполнить его контентом, а затем отправить на модерацию для публикации.

## Статусы сообществ

### 1. **draft** (Черновик)
- Сообщество создано, но еще не готово к публикации
- Владелец может редактировать все параметры
- Не видно на публичной части сайта
- Только владелец видит сообщество в своем дашборде

### 2. **pending_moderation** (На модерации)
- Сообщество отправлено на модерацию
- Владелец не может редактировать до завершения модерации
- Создается автоматическая задача модерации для админов
- Не видно на публичной части сайта

### 3. **published** (Опубликовано)
- Сообщество прошло модерацию и опубликовано
- Видно всем пользователям на публичной части сайта
- Владелец может продолжать редактирование

## Изменения в базе данных

### Миграция: `20241212_add_community_status.sql`

#### 1. Добавлен enum тип
```sql
CREATE TYPE community_status AS ENUM ('draft', 'pending_moderation', 'published');
```

#### 2. Добавлено поле status
```sql
ALTER TABLE communities 
ADD COLUMN status community_status DEFAULT 'draft';
```

#### 3. Миграция существующих данных
```sql
UPDATE communities
SET status = CASE 
  WHEN is_published = true THEN 'published'::community_status
  ELSE 'draft'::community_status
END;
```

#### 4. Обновлены RLS политики
- Публичная часть: только `status = 'published'`
- Владелец: видит свои сообщества в любом статусе
- Админ: видит все сообщества независимо от статуса

#### 5. Обновлены триггеры модерации
- Создание задачи модерации при `status = 'pending_moderation'`
- Автоматическое обновление статуса задачи при публикации
- Отклонение задачи при возврате в черновик

## Изменения в коде

### TypeScript типы (`lib/supabase/communities.ts`)

```typescript
export type CommunityStatus = 'draft' | 'pending_moderation' | 'published';

export const CommunityStatusLabels: Record<CommunityStatus, string> = {
  draft: 'Черновик',
  pending_moderation: 'На модерации',
  published: 'Опубликовано',
};

export const CommunityStatusColors: Record<CommunityStatus, string> = {
  draft: 'gray',
  pending_moderation: 'yellow',
  published: 'green',
};
```

### Создание сообщества (`app/dashboard/create-community/actions.ts`)

**Изменено:**
- По умолчанию устанавливается `status: 'draft'`
- Поле `is_published` сохранено для обратной совместимости

### Отправка на модерацию (`app/dashboard/create-community/actions.ts`)

**Новая функция:**
```typescript
export async function submitCommunityForModeration(communityId: string)
```

**Функционал:**
- Проверка прав владельца
- Проверка текущего статуса (нельзя отправить уже опубликованное или находящееся на модерации)
- Установка статуса `pending_moderation`
- Триггер автоматически создаст задачу модерации

### Публичная часть

**Обновлены запросы:**
- `getCommunities()` - фильтр `.eq('status', 'published')`
- `getCommunityBySlug()` - фильтр `.eq('status', 'published')`
- `getRelatedCommunities()` - фильтр `.eq('status', 'published')`

### Админ-панель (`app/admin/communities/`)

**Статистика:**
- Всего сообществ
- Опубликовано
- На модерации
- Черновики

**Фильтры:**
- Все
- Опубликованные
- На модерации
- Черновики

**Действия:**
- Опубликовать/Снять с публикации

### Дашборд владельца

**Карточки сообществ (`app/dashboard/components/UserCommunities.tsx`):**
- Отображение статуса с цветовой индикацией
- Иконки для каждого статуса

**Настройки сообщества (`app/dashboard/community/[slug]/settings/page.tsx`):**
- Отображение текущего статуса
- Кнопка "Отправить на модерацию" для черновиков
- Информационные сообщения для каждого статуса

**Компонент кнопки модерации (`app/dashboard/community/[slug]/settings/components/SubmitToModerationButton.tsx`):**
- Подтверждение действия
- Индикация загрузки
- Обработка ошибок

## Workflow использования

### Для владельца сообщества

1. **Создание сообщества**
   - Заполнить базовую информацию
   - Сообщество создается со статусом `draft`

2. **Наполнение контентом**
   - Загрузить логотип и обложку
   - Добавить описание
   - Настроить страницу
   - Добавить медиа-контент

3. **Отправка на модерацию**
   - Перейти в настройки сообщества
   - Нажать "Отправить на модерацию"
   - Подтвердить действие
   - Статус меняется на `pending_moderation`

4. **Ожидание модерации**
   - Редактирование недоступно
   - Можно просматривать сообщество

5. **После модерации**
   - Админ публикует → статус `published`
   - Или отклоняет → статус `draft`

### Для администратора

1. **Просмотр сообществ на модерации**
   - Админ-панель → Сообщества
   - Фильтр "На модерации"

2. **Модерация**
   - Просмотр сообщества
   - Проверка контента
   - Опубликовать или вернуть в черновик

3. **Управление**
   - Просмотр всех статусов
   - Статистика по статусам
   - Массовые операции

## Обратная совместимость

- Поле `is_published` сохранено и синхронизируется со `status`
- Существующие сообщества автоматически мигрированы
- API остается совместимым с предыдущей версией

## Безопасность

- RLS политики обеспечивают:
  - Публичный доступ только к опубликованным
  - Владелец видит только свои сообщества
  - Админ видит все сообщества
- Проверка прав при отправке на модерацию
- Проверка прав при публикации

## Применение миграции

```bash
# Применить миграцию в Supabase
supabase db push

# Или через SQL редактор в панели Supabase
# Выполнить содержимое файла supabase/migrations/20241212_add_community_status.sql
```

## Дальнейшие улучшения

- [ ] Email-уведомления при изменении статуса
- [ ] История изменений статусов
- [ ] Комментарии модератора при отклонении
- [ ] Автоматическая публикация после истечения срока модерации
- [ ] Аналитика по статусам