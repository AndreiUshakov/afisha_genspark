# Руководство по удалению сообществ

Реализован полный функционал мягкого и жесткого удаления сообществ с каскадным удалением событий.

## Архитектура решения

### 1. Мягкое удаление (Soft Delete)

Использован подход с полем `deleted_at` в таблицах `communities` и `events`:
- `deleted_at IS NULL` - запись активна
- `deleted_at IS NOT NULL` - запись мягко удалена

**Преимущества:**
- Данные сохраняются в БД для возможного восстановления
- История и архив событий остаются доступны для анализа
- Защита от случайного удаления
- Возможность аудита удаленных записей

### 2. Структура БД

#### Добавленные поля
```sql
-- communities
ALTER TABLE communities ADD COLUMN deleted_at TIMESTAMPTZ DEFAULT NULL;

-- events  
ALTER TABLE events ADD COLUMN deleted_at TIMESTAMPTZ DEFAULT NULL;
```

#### Индексы для оптимизации
```sql
CREATE INDEX idx_communities_deleted_at ON communities(deleted_at) WHERE deleted_at IS NULL;
CREATE INDEX idx_events_deleted_at ON events(deleted_at) WHERE deleted_at IS NULL;
```

### 3. RLS политики

#### Для обычных пользователей
- Видят только активные записи (`deleted_at IS NULL`)
- Владельцы видят свои сообщества в любом статусе

#### Для администраторов
- Видят ВСЕ записи, включая удаленные
- Могут восстанавливать и окончательно удалять записи

## Функционал для владельцев сообществ

### Страница удаления

**Путь:** `/dashboard/community/[slug]/settings/delete`

**Функции:**
1. Отображение информации о сообществе
2. Статистика событий (всего, будущих, прошедших)
3. Список запланированных событий
4. Выбор опции удаления событий:
   - **Удалить все события** - мягкое каскадное удаление всех событий
   - **Удалить только будущие** - прошедшие остаются как архив
5. Подтверждение через ввод имени сообщества
6. Защита от вставки текста (отключена вставка Ctrl+V)

### Процесс удаления

1. Владелец переходит в Настройки сообщества
2. В разделе "Опасная зона" нажимает "Удалить"
3. Просматривает информацию о сообществе и событиях
4. Выбирает опцию удаления событий
5. Вводит имя сообщества вручную для подтверждения
6. Нажимает "Удалить сообщество"
7. Перенаправляется на страницу дашборда

## Функционал для администраторов

### Админ-панель сообществ

**Путь:** `/admin/communities`

**Возможности:**

#### Фильтры
- **Активные** - все не удаленные сообщества
- **Удаленные** - мягко удаленные сообщества
- **Все** - включая удаленные
- **Опубликованные** - активные опубликованные
- **На модерации** - активные на модерации

#### Действия с удаленными сообществами

1. **Восстановление**
   - Кнопка "Восстановить"
   - Восстанавливает `deleted_at = NULL`
   - Сообщество снова видно пользователям

2. **Жесткое удаление**
   - Кнопка "Удалить навсегда"
   - Требует двойного подтверждения
   - Окончательно удаляет:
     - Само сообщество
     - Все связанные события
     - Медиа-файлы
     - Контент-блоки
   - **ВНИМАНИЕ:** Данные невозможно восстановить!

### Визуальные индикаторы

Удаленные сообщества отображаются с:
- Красным фоном строки
- Зачеркнутым названием
- Меткой "Удалено" с датой
- Полупрозрачным аватаром

## API функции (PostgreSQL)

### soft_delete_community()
```sql
soft_delete_community(community_id UUID, delete_option TEXT)
```

**Параметры:**
- `community_id` - ID сообщества
- `delete_option` - 'all' или 'future'

**Возвращает:**
```json
{
  "success": true,
  "deleted_events": 5,
  "future_events_count": 3,
  "community_name": "Название сообщества"
}
```

### restore_community()
```sql
restore_community(p_community_id UUID)
```

Восстанавливает мягко удаленное сообщество.

### hard_delete_community()
```sql
hard_delete_community(p_community_id UUID)
```

Навсегда удаляет сообщество и все связанные данные из БД.

## Server Actions

### Для владельцев

**Файл:** `app/dashboard/community/[slug]/settings/delete/actions.ts`

- `getCommunityEventsInfo()` - получение информации о событиях
- `softDeleteCommunity()` - мягкое удаление с проверками

### Для администраторов

**Файл:** `app/admin/communities/actions.ts`

- `restoreCommunity()` - восстановление сообщества
- `hardDeleteCommunity()` - жесткое удаление

## Безопасность

### Защита от случайного удаления

1. **Подтверждение через ввод имени**
   - Пользователь должен точно ввести имя сообщества
   - Вставка текста отключена

2. **Двойное подтверждение для жесткого удаления**
   - Первый клик - появляется кнопка подтверждения
   - Второй клик - выполняется удаление

3. **Права доступа**
   - Владелец может удалить только свои сообщества
   - Только администраторы могут восстанавливать и удалять навсегда

### RLS политики

Все операции защищены политиками Row Level Security:
- Владелец видит только свои сообщества
- Администратор видит все записи
- Удаленные записи скрыты от обычных пользователей

## Миграция

**Файл:** `supabase/migrations/20241217_add_soft_delete.sql`

Для применения миграции:
```bash
# Локально
supabase db reset

# На продакшене
supabase db push
```

## Использование

### Для владельца сообщества

1. Перейти в `/dashboard/community/[slug]/settings`
2. Нажать "Удалить" в разделе "Опасная зона"
3. Выбрать опцию удаления событий
4. Ввести имя сообщества
5. Подтвердить удаление

### Для администратора

#### Восстановление
1. Перейти в `/admin/communities`
2. Выбрать фильтр "Удаленные"
3. Нажать "Восстановить" у нужного сообщества

#### Окончательное удаление
1. Перейти в `/admin/communities`
2. Выбрать фильтр "Удаленные"
3. Нажать "Удалить навсегда"
4. Подтвердить повторным нажатием

## Что удаляется каскадно

При мягком удалении сообщества:
- ✅ События (в зависимости от выбранной опции)
- ❌ Медиа-файлы (остаются в хранилище)
- ❌ Контент-блоки (остаются в БД)

При жестком удалении сообщества:
- ✅ Все события
- ✅ Медиа-файлы из БД
- ✅ Контент-блоки
- ✅ Само сообщество

**Примечание:** Файлы в Supabase Storage требуют отдельной очистки.

## Рекомендации

1. **Используйте мягкое удаление по умолчанию**
   - Позволяет восстановить данные
   - Сохраняет историю

2. **Жесткое удаление только для:**
   - Тестовых данных
   - Спам-сообществ
   - По истечении срока хранения (например, через 30 дней)

3. **Регулярный аудит удаленных записей**
   - Проверяйте список удаленных сообществ
   - Принимайте решение о жестком удалении или восстановлении

## Возможные улучшения

1. **Автоматическая очистка**
   - Жесткое удаление через N дней
   - Cron job для очистки старых удаленных записей

2. **Уведомления**
   - Email владельцу после удаления
   - Предупреждение перед автоматическим жестким удалением

3. **Логирование**
   - Сохранение истории удалений
   - Кто, когда и почему удалил

4. **Восстановление событий**
   - При восстановлении сообщества давать выбор восстановления событий

## Поддержка

При возникновении проблем проверьте:
1. Применена ли миграция
2. Обновлены ли RLS политики
3. Есть ли права у пользователя
4. Проверьте логи Supabase

## Changelog

### 2024-12-17
- ✅ Создана миграция для мягкого удаления
- ✅ Реализована страница удаления для владельцев
- ✅ Добавлен функционал восстановления для админов
- ✅ Добавлено жесткое удаление для админов
- ✅ Обновлены RLS политики
- ✅ Добавлена каскадная обработка событий