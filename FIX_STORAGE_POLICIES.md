# Исправление политик Storage для загрузки аватаров

## Проблема

Ошибка при загрузке файлов: `new row violates row-level security policy (statusCode: 403)`

## Решение

Применить упрощенные политики безопасности для Storage bucket.

## Инструкция

### Вариант 1: Через Supabase Dashboard (рекомендуется)

1. Откройте [Supabase Dashboard](https://app.supabase.com)
2. Выберите ваш проект
3. Перейдите в **SQL Editor**
4. Нажмите **New Query**
5. Скопируйте и вставьте содержимое файла:
   ```
   supabase/migrations/20231209_create_profiles_bucket_v2.sql
   ```
6. Нажмите **Run** или `Ctrl+Enter`
7. Дождитесь сообщения "Success"

### Вариант 2: Через Supabase CLI

```bash
# Применить миграцию
supabase db push
```

## Что делает миграция

1. ✅ Создает bucket `profiles` (если не существует)
2. ✅ Удаляет старые политики
3. ✅ Создает новые упрощенные политики:
   - **SELECT**: Все могут просматривать файлы (публичный доступ)
   - **INSERT**: Авторизованные пользователи могут загружать
   - **UPDATE**: Авторизованные пользователи могут обновлять
   - **DELETE**: Авторизованные пользователи могут удалять

## Проверка

После применения миграции:

1. Перейдите в **Storage → Policies**
2. Выберите bucket `profiles`
3. Должны быть видны 4 политики:
   - Публичный доступ к файлам профилей (SELECT)
   - Пользователи могут загружать файлы в profiles (INSERT)
   - Пользователи могут обновлять файлы в profiles (UPDATE)
   - Пользователи могут удалять файлы в profiles (DELETE)

## Тестирование

1. Перейдите на `/dashboard/profile`
2. Кликните на аватар
3. Выберите изображение (до 5MB)
4. Изображение должно загрузиться и отобразиться
5. Проверьте в **Storage → profiles → avatars** - файл должен появиться

## Troubleshooting

### Ошибка "policy already exists"

Это нормально при повторном применении. Миграция использует `DROP POLICY IF EXISTS`.

### Файл все еще не загружается

1. Проверьте, что пользователь авторизован
2. Проверьте размер файла (максимум 5MB)
3. Проверьте формат файла (должен быть image/*)
4. Проверьте консоль браузера на наличие других ошибок
5. Проверьте логи сервера

### Bucket не создается

Создайте bucket вручную:
1. Storage → New bucket
2. Name: `profiles`
3. Public: ✅ (включено)
4. Затем примените только политики из миграции

## Дополнительная безопасность (опционально)

Если хотите ограничить пользователей загружать только в свои папки, можно использовать более строгие политики. Но для начала рекомендуется использовать упрощенные политики из этой миграции.

## Связанные файлы

- Миграция: [`supabase/migrations/20231209_create_profiles_bucket_v2.sql`](supabase/migrations/20231209_create_profiles_bucket_v2.sql)
- Старая миграция: [`supabase/migrations/20231209_create_profiles_bucket.sql`](supabase/migrations/20231209_create_profiles_bucket.sql)
- Документация: [`PROFILE_MIGRATION_GUIDE.md`](PROFILE_MIGRATION_GUIDE.md)